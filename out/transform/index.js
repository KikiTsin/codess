"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.writeImgLocal=exports.getImgSource=exports.transformCodeToFile=exports.getImgCookCode=exports.getToken=exports.getImgCookToken=void 0;const t=e(require("./utils/cookie")),o=require("./utils/dsl"),r=require("./utils/socks5Http"),s=require("node:path"),n=require("node:fs"),a=e(require("axios")),c=require("./enum"),i=require("./utils"),l=require("axios-socks5-agent"),g=require("fs-extra"),p={host:"29.2.70.186",port:1080},{httpAgent:u,httpsAgent:m}=new l({agentOptions:{keepAlive:!0},...p}),d="dev",h={httpAgent:u,httpsAgent:m},k={htmlUrl:"https://www.imgcook.com/editor#/",getCodeUrl:"https://www.imgcook.com/api/v2/gen-layout-process"};let w=new t.default,x="";const f=async()=>a.default.get(k.htmlUrl,{responseType:"text",timeout:3e4}).then((({data:e,headers:t})=>{w.parserList(t["set-cookie"]);try{const t=e.match(/<meta[^>]+/g).find((e=>e.match("csrf-token"))).match(/content="([^"]+)"/)[1];t&&(x=t)}catch(e){throw new Error("获取html_token失败")}})).catch((e=>{console.log(e)}));exports.getImgCookToken=f;const C=async()=>{let e;if(e=w.getOne("ctoken"),e&&x)return x;if(await(0,exports.getImgCookToken)(),e=w.getOne("ctoken"),e&&x)return x;throw new Error("获取page_token失败")};exports.getToken=C;const I=async e=>{void 0!==x&&void 0!==w||(w=new t.default,x="");const o=await(0,exports.getToken)();console.log("获取ctoken成功:",o);const s={ctoken:o,original_pic:e.artboardImg||"",data:e,options:{useThreshold:!0,combineCols:!0,composeText:!0,adaptSpace:!0,composeRepeat:!0,dirtyFilter:!0,checkUseless:!0,checkShape:!0},levelProcess:1,teamConfig:{},moduleInfo:{}},n=w.getAll().replace(/;\s/,";").replace(/;$/,"");return console.log("cookie",w),new Promise(((e,t)=>{(0,r.socks5Http)({method:"POST",data:s,cookie:n,timeout:6e4,socks5:"",url:k.getCodeUrl}).then((o=>{const{data:r,success:s,status:n,errorMsg:a}=o;if("true"===s&&n&&r)return e(r);t(new Error(a||"解析错误，请检查格式"))}))}))};exports.getImgCookCode=I;const T=async e=>new Promise((async(t,r)=>{const{lang:n="vue",dir:a="",data:l,useTailwind:p=0}=e,u=c.pathConfig.root,m=(0,s.join)(u,a,"dist"),d=l;let h={};g.removeSync(m),g.ensureDirSync(`${m}/image`);try{h=(0,i.getImgFileMap)(d),await(0,exports.writeImgLocal)(h,m)}catch(e){h={},console.error("下载图片失败")}const k=await(0,exports.getImgCookCode)(d).catch((()=>"{}"));await(0,o.buildCode)({transformedData:JSON.parse(k),outputPath:m,imgFileMap:h,lang:n,useTailwind:!!Number(p)}).catch((()=>({}))),t({code:0,data:{message:"success"}})}));exports.transformCodeToFile=T;const y=e=>{const{url:t,imgPath:o}=e;return new Promise(((e,r)=>{a.default.get(t,{responseType:"stream",timeout:3e5}).then((({data:t,headers:r})=>{console.log(t),console.log(r);const s=(0,n.createWriteStream)(o);t.pipe(s),e(!0)})).catch((()=>{r()}))}))};exports.getImgSource=y;const v=(e,t)=>{let o=[];for(const r in e)o.push((0,exports.getImgSource)({url:r,imgPath:e[r].replace(".",t)}));return new Promise(((e,t)=>{Promise.all(o).then((()=>{e(!0)})).catch((()=>{t()}))}))};exports.writeImgLocal=v;