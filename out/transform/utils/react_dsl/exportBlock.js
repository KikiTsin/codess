"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("./utils"),t=require("./consts");function s(s,n){return new Promise((async o=>{const{prettier:a,scale:r,componentsMap:p,folder:i,blocksCount:c,pagesCount:l,blockInPage:d,dslConfig:u={},pageGlobalCss:$,imgFileMap:m}=n,f=u.globalCss&&1==c&&!d,{cssUnit:h}=(s.fileName,u),y=s;let S,g="index";"Page"==s.componentName?(S="",u.outputStyle==t.OUTPUT_TYPE.PROJECT&&(g="App")):S=0==l&&1==c&&u.outputStyle!==t.OUTPUT_TYPE.PROJECT?"":"components/"+s.fileName,s.folderName=S;s.css;const C=[],j=[],N=[],k=new Map,x={},b=[];let P=[],O=[];const T=[];let E=[];const I=[],A=`${g}${u.inlineStyle==t.CSS_TYPE.MODULE_CLASS?".module":""}.${u.cssType||"css"}`;u.inlineStyle!==t.CSS_TYPE.INLINE_CSS&&(f&&N.push("import './global.css';"),u.inlineStyle==t.CSS_TYPE.IMPORT_CLASS?N.push(`import './${A}';`):N.push(`import styles from './${A}';`));const L=(s,n=!1)=>{if("string"==typeof s)return s;if(Array.isArray(s))return s.map((e=>L(e,n))).join("");let o=s.componentName.toLowerCase(),a=s.componentName,r=[],i=[];if(s.nodeLayerName&&s.nodeLayerName.includes("#component")){const e=s.nodeLayerName.split(/\#|\:/);e.length>1&&(a=e[e.length-2],a.includes("/")&&(i=a.split("/"),r=i.slice(1,i.length),a=a.split("/")[0]),p[a]&&!s.isGenerated&&(o=a))}let c,l=s.props&&s.props.className,d=s.classString||"";l&&(x[l]=(0,e.parseStyle)(s.props.style));let u="";switch(Object.keys(s.props).forEach((t=>{"codeStyle"===t&&s.props[t]&&"{}"!==JSON.stringify(s.props[t])&&(u+=` style={${(0,e.parseProps)(s.props[t])}}`),-1===["className","style","text","src","key","codeStyle"].indexOf(t)&&(u+=` ${t}={${(0,e.parseProps)(s.props[t])}}`),"text"!==o&&["text"].includes(t)&&(u+=` ${t}={${(0,e.parseProps)(s.props[t])}}`)})),o){case"text":let o=(0,e.parseProps)(s.props.text||s.text,!0)||"";o.match(/this\.props/)&&(o=o.replace(/this\./,"")),c=`<span ${d} ${u}>${o||""}</span>`;break;case"image":let i=(0,e.parseProps)(s.props.src);const $=function(e,t){if(!t)return'""';let s=new Set,n=t,o=e.split("/").length;if(e&&o>0){let e=new Array(o).fill("..");n=t.replace(".",`${e.join("/")}`)}const a=t.replace(".png","").split("/"),r=a[a.length-1];return s.add({exportName:r,name:r}),k.set(n,s),r}(S,m[s.props.src]);i=i&&`src={${$}}`||"",c=`<img ${d} ${u} ${i} />`;break;case"page":case"block":case"component":if(n){const e=s.fileName;c=`<${e} />`;const t="Page"==y.componentName?"./components":"..";e&&j.push(`import ${e} from '${t}/${e}';`),delete x[l]}else c=s.children&&s.children.length?`<div ${d} ${u}>${s.children.map((e=>L(e,!0))).join("")}</div>`:`<div ${d} ${u} />`;break;case"div":case"view":c=s.children&&s.children.length?`<div ${d} ${u}>${s.children.map((e=>L(e,!0))).join("")}</div>`:`<div ${d} ${u} />`;break;default:if(a){let n={...p[a]};if(s.isGenerated=!0,r.length)for(let e of r)n[e]&&(n.props={...n.props,...n[e].props});if((e=>{if(!e)return;const t=p[e];if(!t)return;const s=k.get(t.packageName);if(s)s.add(t);else{const e=new Set;e.add(t),k.set(t.packageName,e)}C.find((e=>e.package==t.packageName))||C.push({package:t.packageName,version:t.dependenceVersion||"*"})})(a),u="","Input"===n.name)(0,e.handleField)(n,{text:(0,e.findText)(s)});Object.keys(n.props).forEach((t=>{const s=Object.keys(n.state||{}).includes(n.props[t]);u+=` ${t}={${(0,e.parseProps)(n.props[t],!1,s)}}`})),_(n),t.compExcludeClassnames.includes(a)&&(d=""),c=s.children&&s.children.length&&Array.isArray(s.children)&&!t.notRenderChildrenComps.includes(a)?`<${a} ${d} ${u}>${s.children.map((e=>L(e,!0))).join("")}</${a}>`:"string"==typeof s.children?`<${a} ${d} ${u} >${s.children}</${a}>`:`<${a} ${d} ${u} />`}else c=""}if(s.loop){const t=(0,e.parseLoop)(s.loop,s.loopArgs,c,{});c=t.value,P=P.concat(t.hookState)}return c=(0,e.replaceState)(c),s.condition&&(c=(0,e.parseCondition)(s.condition,c)),(s.loop||s.condition)&&(c=`{${c}}`),c},_=t=>{if(t.methods&&Object.keys(t.methods).forEach((s=>{const{params:n,content:o}=(0,e.parseFunction)(t.methods[s]);T.push(`function ${s}(${n}) {${o}}`)})),t.dataSource&&Array.isArray(t.dataSource.list)&&(t.dataSource.list.forEach((t=>{"boolean"==typeof t.isInit&&t.isInit?I.push(`${t.id}();`):"string"==typeof t.isInit&&I.push(`if (${(0,e.parseProps)(t.isInit)}) { ${t.id}(); }`);const s=(0,e.parseDataSource)(t);T.push(`const ${s.functionName} = ()=> ${s.functionBody}`)})),t.dataSource.dataHandler)){const{params:s,content:n}=(0,e.parseFunction)(t.dataSource.dataHandler);T.push(`const dataHandler = (${s}) => {${n}}`),I.push("dataHandler()")}if(t.lifeCycles&&(E=(0,e.parseLifeCycles)(t,I)),t.state){let s=Object.keys(t.state);for(let n of s)P.push((0,e.parseState)(n,t.state[n]))}},w=u.useHooks?e=>{if("string"==typeof e)return e;e.fileName||e.id,e.componentName.toLowerCase();_(e);const t=L(e,!1),s=t.match("dispatch"),n=`\n       export default memo((props) => {\n         ${P.join("\n")}\n         ${s?"const { state: { txt }, dispatch} = useContext(IndexContext);":""}\n   \n         ${T.join("\n")}\n         ${E.join("\n")}\n         ${t.match(/^\{true\ \&\& /)?`return (<View>${t}</View>)`:`return (${t})`}\n         });\n         `;return O.push(n),""}:t=>{if("string"==typeof t)return t;let s="";const n=t.componentName.toLowerCase();if(["page","block","component"].includes(n)){const s=[],n=[],o=[],a=[];let r="",p="";if(t.state&&s.push(`this.state = ${(0,e.toString)(t.state)};`),t.methods&&Object.keys(t.methods).forEach((s=>{const{params:n,content:a}=(0,e.parseFunction)(t.methods[s]);o.push(`${s}(${n}) {${a}}`)})),t.dataSource&&Array.isArray(t.dataSource.list)&&(t.dataSource.list.forEach((t=>{"boolean"==typeof t.isInit&&t.isInit?a.push(`this.${t.id}();`):"string"==typeof t.isInit&&a.push(`if (${(0,e.parseProps)(t.isInit)}) { this.${t.id}(); }`);const s=(0,e.parseDataSource)(t);o.push(`${s.functionName}()${s.functionBody}`)})),t.dataSource.dataHandler)){const{params:s,content:n}=(0,e.parseFunction)(t.dataSource.dataHandler);o.push(`dataHandler(${s}) {${n}}`),a.push("this.dataHandler()")}t.lifeCycles||(t.lifeCycles={}),t.lifeCycles._constructor||n.push(`constructor(props, context) { super(); ${s.join("\n")} ${a.join("\n")}}`),Object.keys(t.lifeCycles).forEach((o=>{const{params:r,content:p}=(0,e.parseFunction)(t.lifeCycles[o]);"_constructor"===o?n.push(`constructor(${r}) { super(); ${p}   ${s.join("\n")}  ${a.join("\n")}}`):n.push(`${o}(${r}) {${p}}`)})),r=L(t,!1),p=`\n        export default class ${t.fileName} extends Component {\n          ${n.join("\n")}\n          ${o.join("\n")}\n          render(){ \n            const state = this.state;\n            return (${r});}\n        \n        }\n        `,O.push(p)}else s+=L(t);return s};n.utils&&Object.keys(n.utils).forEach((e=>{b.push(`const ${e} = ${n.utils[e]}`)})),w(s);let v="";const H=(0,e.importString)(k);v=u.useHooks?`\n        'use strict';\n        import { useState, useEffect, memo } from 'react';\n  \n        ${H.join("\n")}\n        ${j.join("\n")}\n  \n        ${N.map((e=>e)).join("\n")}\n        ${b.join("\n")}\n  \n        ${O.join("\n")}\n  \n      `:`\n      'use strict';\n      import { Component} from 'react';\n  \n      ${H.join("\n")}\n      ${j.join("\n")}\n      ${N.map((e=>e)).join("\n")}\n  \n      ${b.join("\n")}\n      ${O.join("\n")}\n    `;const F=u.inlineStyle?"":s.props&&s.props.className,M=(0,e.addAnimation)(s),U=[{panelName:`${g}.${u.useTypescript?"tsx":"jsx"}`,panelValue:a.format(v,t.prettierJsOpt),panelType:u.useTypescript?"tsx":"jsx",folder:S,panelDependencies:C}];if(u.inlineStyle!==t.CSS_TYPE.INLINE_CSS){let n=(0,e.generateCSS)(s.commonStyles,"");switch(u.cssType){case"less":n=a.format(`${n}${(0,e.generateScss)(s)} ${M}`,t.prettierLessOpt);break;case"scss":n=a.format(`${n}${(0,e.generateScss)(s)} ${M}`,t.prettierScssOpt);break;default:n=a.format(`${n}${(0,e.generateCSS)(x,F)} ${M}`,t.prettierCssOpt)}U.push({panelName:A,panelValue:n,panelType:u.cssType||"css",folder:S})}f&&s.css&&U.push({panelName:"global.css",panelValue:a.format(s.css||"",t.prettierCssOpt),panelType:"css",folder:S}),o(U)}))}exports.default=s;