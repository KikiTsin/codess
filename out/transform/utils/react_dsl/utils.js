"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.handleField=exports.findText=exports.importString=exports.addAnimation=exports.transAnimation=exports.getText=exports.parseDataSource=exports.existImport=exports.parseLifeCycles=exports.replaceState=exports.parseState=exports.parseLoop=exports.generateScss=exports.generateCssString=exports.generateCSS=exports.parseCamelToLine=exports.parseCondition=exports.parseProps=exports.toJsString=exports.parseFunction=exports.parseStyle=exports.parseNumberValue=exports.genStyleCode=exports.genStyleClass=exports.traverseBrother=exports.traverse=exports.initSchema=exports.simpleStyle=exports.commonStyle=exports.tailwindStyle=exports.resetCounter=exports.toUpperCaseStart=exports.toString=exports.transComponentsMap=exports.isEmptyObj=exports.line2Hump=exports.isExpression=exports.getGlobalClassNames=exports.getCssRules=void 0;const t=require("lodash/find"),r=require("lodash/unset"),s=require("lodash/set"),o=require("lodash/get"),n=require("lodash/camelCase"),a=require("lodash/kebabCase"),p=require("lodash/snakeCase"),i=require("css/lib/parse"),c=require("./consts"),l=e(require("../tailwindClassNames")),d=e=>{if(!i)return[];let t=i(e,{source:"global.css"}).stylesheet.rules;return t=t.filter((e=>"rule"===e.type)),t=t.map((e=>{let t={};for(let r of e.declarations){t[n(r.property)]=r.value}return{selectors:e.selectors[0],style:t}})),t};exports.getCssRules=d;const m=(e,s)=>{let o=[];if(!s||!i)return{names:o,style:e};const n=(0,exports.getCssRules)(s);for(let s of n){if(t([e],s.style)&&s.selectors.startsWith(".")){for(let t in s.style)r(e,t);o.push(s.selectors.replace(".",""))}}return{names:o,style:e}};exports.getGlobalClassNames=m;const x=e=>/^\{\{.*\}\}$/.test(e);exports.isExpression=x;const u=e=>e=(e=e.replace(/[_|-](\w)/g,((e,t)=>t.toUpperCase()))).charAt(0).toUpperCase()+e.slice(1);exports.line2Hump=u;const g=e=>null!==e&&"[object Object]"===Object.prototype.toString.call(e)&&!Object.keys(e).length;exports.isEmptyObj=g;const f=e=>{if(!e||!Array.isArray(e.list))return[];let t=e.list;for(let r of e.list)r.children&&Array.isArray(r.children)&&(t=t.concat(r.children));return t.reduce(((e,t)=>{const r=t.name;if(!e[r]){if(t.dependence)try{let e="string"==typeof t.dependence?JSON.parse(t.dependence):t.dependence;e&&(t.packageName=e.package),t.dependenceVersion||(t.dependenceVersion="*"),t.exportName=e.export_name,t.subName=e.sub_name,/^\d/.test(t.dependenceVersion)&&(t.dependenceVersion="^"+t.dependenceVersion)}catch(e){console.log(e)}e[r]=t}return e}),{})};exports.transComponentsMap=f;const h=e=>"[object Function]"==={}.toString.call(e)?e.toString():"string"==typeof e?e:"object"==typeof e?JSON.stringify(e,((e,t)=>"function"==typeof t?t.toString():t)):String(e);exports.toString=h;const y=e=>e.charAt(0).toUpperCase()+e.slice(1);exports.toUpperCaseStart=y;let $={};const S=e=>($[e]=($[e]||0)+1,$[e]),b=e=>{$[e]=0};function C(e){return!(e.length>0)||!e.some((function(t,r){return t!==e[0]}))}function N(e){if(e.length<2)return{};let t={};const r=Object.keys(e[0]);for(let s of r)C(e.map((e=>e[s])))&&(t[s]=e[0][s]);return t}function k(e){let t=e.replace(/[A-Z]/g,(function(e){return"-"+e.toLowerCase()}));return"-"===t.slice(0,1)&&(t=t.slice(1)),t}exports.resetCounter=b;const w={padding:"p",paddingTop:"pt",paddingLeft:"pl",paddingRight:"pr",paddingBottom:"pb",margin:"m",marginTop:"mt",marginLeft:"ml",marginRight:"mr",marginBottom:"mb"};function v(e,t="margin"){let s=e.props.style;const o=Object.keys(s).filter((e=>e.startsWith(t)));if(s[t]||o.length<=2)for(let t of o){let o=w[t];if(o){e.tailwindClassnames=e.tailwindClassnames||[];let n=s[t].replace(/[^\d]/gi,"");const a="px";e.tailwindClassnames.push(`${o}-[${n}${a}]`),r(e,`props.style.${t}`)}}}function A(e,t){v(e),v(e,"padding");for(let s in e.props.style){let o=`${k(s)}: ${e.props.style[s]}`;t[o]&&(e.tailwindClassnames=e.tailwindClassnames||[],e.tailwindClassnames.push(t[o]),r(e,`props.style.${s}`))}0===Object.keys(e.props.style).length&&r(e,"props.className")}const j=e=>{(0,exports.traverseBrother)(e,(function(e){for(let t of e)A(t,l.default)}))};exports.tailwindStyle=j;const O=e=>{(0,exports.traverseBrother)(e,(function(t){const o=N(t.filter((e=>e.props&&e.props.style)).map((e=>e.props.style)));if(Object.keys(o).length>3){const n=(0,exports.genStyleClass)("common_"+t[0].props.className,c.DSL_CONFIG.cssStyle);s(e,`commonStyles.${n}`,(0,exports.parseStyle)(o));for(let e of t){for(let t of Object.keys(o))r(e,`props.style.${t}`);e.classnames=e.classnames||[],e.classnames.push(n)}}}))};exports.commonStyle=O;const L=e=>{let t=[];(0,exports.traverse)(e,(e=>{const r=o(e,"props.style.fontFamily");r&&t.push(r)}));const n=o(e,"props.style.fontFamily")||function(e){let t={},r=0,s=null;for(let o=0;o<e.length;o++)null==t[e[o]]?t[e[o]]=1:t[e[o]]++,t[e[o]]>r&&(s=e[o],r=t[e[o]]);return s}(t);return n&&((0,exports.traverse)(e,(e=>{o(e,"props.style.fontFamily")==n&&r(e,"props.style.fontFamily")})),s(e,"props.style.fontFamily",n)),(0,exports.traverse)(e,(e=>{const t=(e,t,s)=>{const n=o(e,`props.style.${t}`);s.includes(String(n)||"")&&r(e,`props.style.${t}`)};t(e,"fontWeight",["400",400,"normal"]),t(e,"flexDirection",["row"]),t(e,"textDecoration",["none"])})),e};exports.simpleStyle=L;const F=e=>{(0,exports.resetCounter)("page"),(0,exports.resetCounter)("block"),(0,exports.resetCounter)("component"),(0,exports.traverse)(e,(e=>{e&&e.props&&e.props.className&&(e.props.className=String(e.props.className).trim()),e.componentName=e.componentName||"div"})),(0,exports.traverse)(e,(e=>{e.props&&e.props.className&&(e.props.className=(0,exports.genStyleClass)(e.props.className,c.DSL_CONFIG.cssStyle))})),(0,exports.traverse)(e,(e=>{switch(e.componentName=e.componentName||"",e.componentName.toLowerCase()){case"page":e.fileName=(0,exports.line2Hump)(e.fileName||`page_${S("page")}`);break;case"block":e.fileName=(0,exports.line2Hump)(e.fileName||`block_${S("block")}`);break;case"component":e.fileName=(0,exports.line2Hump)(e.fileName||`component_${S("component")}`)}})),(0,exports.traverse)(e,(e=>{"Text"==e.componentName&&delete e.props.lines}))};exports.initSchema=F;const _=(e,t)=>{Array.isArray(e)?e.forEach((e=>{(0,exports.traverse)(e,t)})):(e&&t&&t(e),e.children&&e.children.length>0&&Array.isArray(e.children)&&e.children.forEach((e=>{(0,exports.traverse)(e,t)})))};exports.traverse=_;const E=(e,t)=>{Array.isArray(e)?e.forEach((e=>{(0,exports.traverseBrother)(e,t)})):(e&&Array.isArray(e.children)&&t&&t(e.children),e.children&&e.children.length>0&&Array.isArray(e.children)&&e.children.forEach((e=>{(0,exports.traverseBrother)(e,t)})))};exports.traverseBrother=E;const R=(e,t)=>{let r=e.split(" ");return r=r.filter((e=>!!e)),r=r.map((e=>{switch(t){case"camelCase":default:return n(e);case"kebabCase":return a(e);case"snakeCase":return p(e)}})),r.join(" ")};exports.genStyleClass=R;const T=(e,t="")=>!/-/.test(t)&&t.trim()?`${e}.${t}`:`${e}['${t}']`;exports.genStyleCode=T;const B=e=>{const{cssUnit:t="px",scale:r,responseWidth:s}=c.DSL_CONFIG;if(e=String(e).replace(/\b[\d\.]+(px|rem|rpx|vw)?\b/,(e=>{const t=parseFloat(e);return isNaN(t)||0===t?0:(0,exports.toString)(t)})),/^\-?[\d\.]+$/.test(e))if(e=parseFloat(e),"rpx"==t)e=0==(e=750*e/Number(s))?e:e+"rpx";else if("rem"==t){const t=c.DSL_CONFIG.htmlFontSize||16;e=(e=parseFloat((e/t).toFixed(2)))?`${e}rem`:e}else if("vw"==t){const t=750/r;e=0==(e=(100*parseInt(e)/t).toFixed(2))?e:e+"vw"}else e+=t;return e};exports.parseNumberValue=B;const D=e=>{const{scale:t,cssUnit:r}=c.DSL_CONFIG,s={};for(let r in e)switch(r){case"fontSize":case"marginTop":case"marginBottom":case"paddingTop":case"paddingBottom":case"height":case"top":case"bottom":case"width":case"maxWidth":case"left":case"right":case"paddingRight":case"paddingLeft":case"marginLeft":case"marginRight":case"lineHeight":case"borderBottomRightRadius":case"borderBottomLeftRadius":case"borderTopRightRadius":case"borderTopLeftRadius":case"borderRadius":s[r]=parseInt(e[r])*t,e[r]&&(s[r]=(0,exports.parseNumberValue)(e[r]));break;default:e[r]&&String(e[r]).includes("px")&&(s[r]=String(e[r]).replace(/[\d\.]+px/g,(e=>/^[\d\.]+px$/.test(e)?(0,exports.parseNumberValue)(e):e))),s[r]=s[r]||e[r]}return s};exports.parseStyle=D;const U=e=>{const t=e.toString();return{params:t.match(/\([^\(\)]*\)/)[0].slice(1,-1),content:t.slice(t.indexOf("{")+1,t.lastIndexOf("}"))}};exports.parseFunction=U;const q=e=>"string"==typeof e&&e.includes("'")?`\`${e}\``:`'${e}'`;exports.toJsString=q;const I=(e,t=!1,r=!1)=>{const s="string"==typeof e&&e.includes("=>");if("function"==typeof e||s){const{params:t,content:r}=(0,exports.parseFunction)(e);return`(${t}) => {${r}}`}return"string"==typeof e?(0,exports.isExpression)(e)?t?e.slice(1,-1):e.slice(2,-2):r?`${e}`:t?e:`${(0,exports.toJsString)(e)}`:"object"==typeof e?`${JSON.stringify(e)}`:e};exports.parseProps=I;const V=(e,t)=>"boolean"==typeof e?`${e} && ${t}`:"string"==typeof e?`${(e=e.replace(/this\./,"")).slice(2,-2)} && ${t}`:void 0;exports.parseCondition=V;const W=e=>e.split(/(?=[A-Z])/).join("-").toLowerCase();exports.parseCamelToLine=W;const G=(e,t)=>{let r="";for(let s in e)r+=`${t&&t!==s?"."+t+" ":""}.${s} {`,r+=(0,exports.generateCssString)(e[s]),r+="}";return r};exports.generateCSS=G;const H=["position","display","float","left","top","right","bottom","flex-direction","justify-content","align-items","align-self","overflow","clear","z-index","width","height","max-width","max-height","padding","padding-bottom","padding-left","padding-right","padding-left","border","margin","margin-top","margin-bottom","margin-left","margin-right","background","background-color","background-image","background-size","font-family","font-size","font-style","font-weight","font-varient","line-height","color","text-align","vertical-align","text-wrap","text-transform","text-indent","text-decoration","letter-spacing","word-spacing","white-space","text-overflow","content","box-shadow","border-radius","transform"],M=e=>{let t="",r=[];const s=Object.keys(e).filter((e=>e.startsWith("margin")));!e.margin&&s.length>2&&(e.margin=`${e.marginTop||0} ${e.marginRight||0} ${e.marginBottom||0} ${e.marginLeft||0}`,delete e.marginTop,delete e.marginLeft,delete e.marginBottom,delete e.marginRight);const o=Object.keys(e).filter((e=>e.startsWith("padding")));!e.padding&&o.length>2&&(e.padding=`${e.paddingTop||0} ${e.paddingRight||0} ${e.paddingBottom||0} ${e.paddingLeft||0}`,delete e.paddingTop,delete e.paddingLeft,delete e.paddingBottom,delete e.paddingRight);for(let t in e){const s=(0,exports.parseCamelToLine)(t),o=H.indexOf(s);r.push({key:s,value:e[t],index:-1==o?100:o})}return r.sort(((e,t)=>e.index-t.index)),t=r.map((e=>`${e.key}: ${e.value};`)).join(""),t};exports.generateCssString=M;const J=e=>{let t="";return function e(r){if(r.props.className){let e=r.props.className;t+=`.${e}{`,t+=`${(0,exports.generateCssString)((0,exports.parseStyle)(r.props.style))};`}r.children&&r.children.length>0&&r.children.forEach((t=>{["block","component","page"].includes(t.componentName.toLowerCase())||e(t)})),r.props.className&&(t+="}")}(e),t};exports.generateScss=J;const P=(e,t,r,s={})=>{let o,n=t&&t[0]||"item",a=t&&t[1]||"index";Array.isArray(e)?o=(0,exports.toString)(e):(0,exports.isExpression)(e)&&(o=e.slice(2,-2));const p=r.match(/^<.+?\s/)[0].length;r=`${r.slice(0,p)} key={${a}}${r.slice(p)}`;const i=new RegExp(`this.${n}`,"g");r=r.replace(i,n);let c=o;o.match(/this\.state\./)&&(c=`state.${o.split(".").pop()}`);return{hookState:[],value:`${c}.map((${n}, ${a}) => {\n      return (${(s.formatRender||function(e){return e})(r)});\n    })`}};exports.parseLoop=P;const z=(e,t)=>`const [${e}, set${(0,exports.toUpperCaseStart)(e)}] = useState(${(0,exports.toString)(t)||""});`;exports.parseState=z;const Z=e=>{const t=new RegExp("this.state","g");return e.replace(t,"state")};exports.replaceState=Z;const K=(e,t)=>{let r=[];return!e.lifeCycles._constructor&&t&&(e.lifeCycles._constructor="function _constructor() {}"),Object.keys(e.lifeCycles).forEach((s=>{let{params:o,content:n}=(0,exports.parseFunction)(e.lifeCycles[s]);switch(n=(0,exports.replaceState)(n),s){case"_constructor":t.push(n),r.unshift(`\n          // constructor\n          useState(()=>{\n            ${t.join("\n")}\n          })\n        `);break;case"componentDidMount":r.push(`\n          // componentDidMount\n          useEffect(()=>{\n            ${n}\n          }, [])\n        `);break;case"componentDidUpdate":r.push(`\n          // componentDidUpdate\n          useEffect(()=>{\n            ${n}\n          })\n        `);break;case"componentWillUnMount":r.push(`\n          // componentWillUnMount\n          useEffect(()=>{\n            return ()=>{\n              ${n}\n            }\n          }, [])\n        `)}})),r};exports.parseLifeCycles=K;const Q=(e,t)=>{let r=!1;return e.forEach((e=>{e._import===t&&(r=!0)})),r};exports.existImport=Q;const X=e=>{const t=e.id,{uri:r,method:s,params:o}=e.options,n=e.type;let a={};Object.keys(e.options).forEach((t=>{-1===["uri","method","params"].indexOf(t)&&(a[t]=(0,exports.toString)(e.options[t]))}));let p=(0,exports.isEmptyObj)(a)?"":",";a=o?"GET"!==s?`${(0,exports.toString)(a).slice(0,-1)} ${p} body: ${(0,exports.isExpression)(o)?(0,exports.parseProps)(o):(0,exports.toString)(o)}}`:`${(0,exports.toString)(a).slice(0,-1)}}`:(0,exports.toString)(a);let i=`{\n  return ${n}(${(0,exports.parseProps)(r)}, ${(0,exports.toString)(a)})\n    .then((response) => response.json())\n`;if(e.dataHandler){const{params:t,content:r}=(0,exports.parseFunction)(e.dataHandler);i+=`.then((${t}) => {${r}})\n    .catch((e) => {\n      console.log('error', e);\n    })\n  `}return i+="}",{value:`${t}() ${i}`,functionName:t,functionBody:i}};exports.parseDataSource=X;const Y=e=>{let t="";const r=e=>{"text"===e.componentName.toLowerCase()&&(t+=(0,exports.parseProps)(e.props.text||e.text,!0).replace(/\{/g,"${")),e.children&&Array.isArray(e.children)&&e.children.map((e=>{r(e)}))};return r(e),t};exports.getText=Y;const ee=function(e){let t="";for(let r of e.keyframes)t+=`${(1e4*r.offset/100).toFixed(0)+"%"} {\n  ${r.opacity?"opacity: ".concat(r.opacity)+";":""}\n  ${r.transform?"transform: ".concat(r.transform)+";":""}\n}\n`;return`\n@keyframes ${e.name} {\n${t}\n}\n`};exports.transAnimation=ee;const te=function(e){let t="";return(0,exports.traverse)(e,(e=>{e.animation&&(t+=(0,exports.transAnimation)(e.animation))})),t};exports.addAnimation=te;const re=e=>{const t=[],r=[];for(const[s,o]of e){const e=new Set,n=new Set;for(const t of o){let s=t.exportName,o=t.subName,a=t.name;t.subName&&r.push(`const ${a} = ${s}.${o};`),s||(s=a),a===s||t.subName||(s=`${s} as ${a}`),t.dependence&&t.dependence.destructuring?n.add(s):e.add(s)}const a=[...e].join(",");let p=[...n].join(",");const i=a&&p?",":"";p&&(p=`{${p}}`),t.push(`import ${a} ${i} ${p} from '${s}'`)}return t.concat(r)};exports.importString=re;const se=e=>{let t=[];return function e(r){for(let s of r)"Text"===s.componentName&&t.push(s.props.text||""),Array.isArray(s.children)&&s.children.length>0&&e(s.children)}(e.children),t.splice(0,2)};exports.findText=se;const oe=(e,t)=>{const{text:r=[]}=t;e.props.label=r[0]||"文本",e.props.placeholder=r[1]||"这里是输入框"};exports.handleField=oe;